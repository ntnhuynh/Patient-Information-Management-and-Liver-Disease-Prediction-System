{% extends "layout/base.html" %}

{% block content %}
<div class="medical-share-wrapper">
    <h2 class="medical-share-title">üîó Chia s·∫ª h·ªì s∆° b·ªánh √°n {{ record_id }}</h2>

    <div class="medical-share-step">
        <label for="department-select"><strong>Ch·ªçn khoa:</strong></label>
        <select id="department-select" class="medical-share-select">
            <option value="">-- Ch·ªçn khoa --</option>
        </select>
    </div>

    <div class="medical-share-step">
        <label for="doctor-search"><strong>T√¨m b√°c sƒ©:</strong></label>
        <input type="text" id="doctor-search" class="medical-share-input" placeholder="Nh·∫≠p t√™n ho·∫∑c email b√°c sƒ©...">
    </div>

    <div id="doctor-list" class="medical-share-doctor-list">
        <!-- Danh s√°ch b√°c sƒ© s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
    </div>

    <div class="medical-share-actions">
        <button id="share-button" class="medical-share-btn" disabled>‚úÖ Chia s·∫ª h·ªì s∆°</button>
        {%if page_type == "department_head"%}
        <button class="medical-share-btn medical-share-back" onclick="window.history.back()">
            ‚¨Ö Quay l·∫°i h·ªì s∆°
        </button>


        {%elif page_type == "doctor"%}
        <a href="/patients_by_doctor/{{user_id}}/staff" class="medical-share-btn medical-share-back">‚¨Ö Quay l·∫°i danh
            s√°ch</a>
        {%endif%}
    </div>

    <script>
        const recordId = {{ record_id }};
        let allDoctors = [];
        let selectedDoctorId = null;

        // Load danh s√°ch khoa
        fetch("/department/list")
            .then(res => res.json())
            .then(departments => {
                const select = document.getElementById("department-select");
                departments.forEach(dept => {
                    const option = document.createElement("option");
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            });

        // Khi ch·ªçn khoa ‚Üí load danh s√°ch b√°c sƒ©
        document.getElementById("department-select").addEventListener("change", function () {
            const khoaId = this.value;
            if (!khoaId) return;

            fetch(`/stats/departments/${khoaId}/staff`)
                .then(res => res.json())
                .then(data => {
                    allDoctors = [];

                    if (data.truong_khoa) {
                        allDoctors.push(data.truong_khoa);
                    }
                    if (Array.isArray(data.bac_si)) {
                        allDoctors = allDoctors.concat(data.bac_si);
                    }

                    renderDoctorList(allDoctors);
                });
        });

        // T√¨m ki·∫øm b√°c sƒ©
        document.getElementById("doctor-search").addEventListener("input", function () {
            const keyword = this.value.toLowerCase();
            const filtered = allDoctors.filter(d =>
                d.full_name.toLowerCase().includes(keyword) ||
                d.email.toLowerCase().includes(keyword)
            );
            renderDoctorList(filtered);
        });

        // Render danh s√°ch b√°c sƒ©
        function renderDoctorList(doctors) {
            const container = document.getElementById("doctor-list");
            container.innerHTML = "";

            if (doctors.length === 0) {
                container.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y b√°c sƒ© n√†o.</p>";
                return;
            }

            doctors.forEach(doc => {
                const div = document.createElement("div");
                div.className = "medical-share-doctor-item";
                div.innerHTML = `
          <label>
            <input type="radio" name="doctor" value="${doc.id}">
            <strong>${doc.full_name}</strong> (${doc.email})
          </label>
        `;
                container.appendChild(div);
            });

            // G·∫Øn s·ª± ki·ªán ch·ªçn b√°c sƒ©
            document.querySelectorAll('input[name="doctor"]').forEach(input => {
                input.addEventListener("change", function () {
                    selectedDoctorId = this.value;
                    document.getElementById("share-button").disabled = false;
                });
            });

            document.getElementById("share-button").disabled = true;
            selectedDoctorId = null;
        }

        // G·ª≠i y√™u c·∫ßu chia s·∫ª
        document.getElementById("share-button").addEventListener("click", function () {
            if (!selectedDoctorId) return;

            fetch(`/medical-record/medical-records/${recordId}/share`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ shared_with: selectedDoctorId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        alert("‚úÖ H·ªì s∆° ƒë√£ ƒë∆∞·ª£c chia s·∫ª!");

                    } else {
                        alert("‚ùå " + (data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
                    }
                });
        });
    </script>
</div>
{% endblock %}