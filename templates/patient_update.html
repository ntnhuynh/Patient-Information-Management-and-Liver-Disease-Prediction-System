{% extends "layout/base.html" %}

{% block content %}
<div class="patient-update-wrapper">
    <h2 class="patient-update-title">‚úèÔ∏è C·∫≠p nh·∫≠t th√¥ng tin b·ªánh nh√¢n {{ patient_id }}</h2>

    <form id="patient-update-form" class="patient-update-form">
        <!-- N·ªôi dung form s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
    </form>

    <div class="patient-update-actions">
        <button type="submit" form="patient-update-form" class="patient-update-btn">üíæ L∆∞u thay ƒë·ªïi</button>
        {%if page_type == "department head"%}
        <a href="/patients/{{ khoa_id }}/staff" class="patient-update-btn patient-update-back">‚¨Ö Quay l·∫°i danh s√°ch</a>
        {%elif page_type == "doctor"%}
        <a href="/patients_by_doctor/{{user_id}}/staff" class="patient-update-btn patient-update-back">‚¨Ö Quay l·∫°i danh
            s√°ch</a>
        {%endif%}
    </div>

    <script>
        const patientId = {{ patient_id }};
        const form = document.getElementById("patient-update-form");

        function safe(val) {
            return val !== null && val !== undefined ? val : "";
        }

        function input(label, name, value = "", type = "text") {
            return `
        <div class="patient-update-field">
          <label><strong>${label}:</strong></label>
          <input type="${type}" name="${name}" value="${value}" class="patient-update-input">
        </div>
      `;
        }

        fetch(`/patient/detail/${patientId}`)  // B·∫°n c·∫ßn t·∫°o route GET n√†y n·∫øu ch∆∞a c√≥
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    form.innerHTML = `<p style="color:red;">${data.error}</p>`;
                    return;
                }

                const patient = data.patient || data;  // T√πy theo c·∫•u tr√∫c JSON b·∫°n tr·∫£ v·ªÅ

                let html = "";
                html += input("H·ªç t√™n", "name", safe(patient.name));
                html += input("Ng√†y sinh", "birth_date", safe(patient.birth_date), "date");
                html += input("Gi·ªõi t√≠nh", "gender", safe(patient.gender));
                html += input("ƒê·ªãa ch·ªâ", "address", safe(patient.address));

                form.innerHTML = html;
            });

        form.onsubmit = function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const jsonData = {};

            formData.forEach((val, key) => {
                if (val !== "") jsonData[key] = val;
            });

            fetch(`/patient/update/${patientId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(jsonData)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                        window.location.href = `/patients_by_doctor/{{user_id}}/staff`;
                    } else {
                        alert("‚ùå " + (data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
                    }
                });
        };
    </script>
</div>
{% endblock %}