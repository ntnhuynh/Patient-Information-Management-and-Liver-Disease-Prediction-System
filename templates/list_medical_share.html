{% extends "layout/base.html" %}

{% block content %}
<div class="medical-share-wrapper">
    <h2 class="medical-share-title">üìÇ H·ªì s∆° ƒë∆∞·ª£c chia s·∫ª</h2>

    <div id="medical-share-list" class="medical-share-list">
        <p>ƒêang t·∫£i danh s√°ch h·ªì s∆°...</p>
    </div>

    <div class="medical-share-actions">
        <a href="/admin/dashboard" class="medical-share-btn medical-share-back">‚¨Ö Quay l·∫°i trang ch·ªß</a>
    </div>

    <script>
        const userId = {{ user_id }};
        const container = document.getElementById("medical-share-list");

        function formatDate(dateStr) {
            if (!dateStr) return "‚Äî";
            const parts = dateStr.split("-");
            if (parts.length !== 3) return "‚Äî";
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        fetch(`/medical-record/shared-records/${userId}`)
            .then(res => res.json())
            .then(data => {
                const ids = data.record_ids || [];
                if (ids.length === 0) {
                    container.innerHTML = "<p>Kh√¥ng c√≥ h·ªì s∆° n√†o ƒë∆∞·ª£c chia s·∫ª.</p>";
                    return;
                }

                Promise.all(ids.map(id => fetch(`/medical-record/get_medical-records/${id}`).then(r => r.json())))
                    .then(records => {
                        let html = "";
                        records.forEach(record => {
                            if (record.error) return;

                            html += `
                                <div class="medical-share-card">
                                    <h3>üßæ H·ªì s∆° ${record.id}</h3>
                                    <p><strong>B·ªánh nh√¢n:</strong> ${record.name} (${record.gender})</p>
                                    <p><strong>Ng√†y sinh:</strong> ${formatDate(record.birth_date)}</p>
                                    <p><strong>Ng√†y kh√°m:</strong> ${formatDate(record.visit_date)}</p>
                                    <p><strong>L√Ω do kh√°m:</strong> ${record.reason_for_visit || "‚Äî"}</p>
                                    <p><strong>Ch·∫©n ƒëo√°n:</strong> ${record.confirmed_diagnosis || "‚Äî"}</p>
                                    <p><strong>B√°c sƒ© t·∫°o:</strong> ${record.created_by}</p>
                                    <a href="/medical-records_detail/${record.id}" class="medical-share-detail-btn">
                                    <img src="/static/img/people.png" alt="avatar" class="detail-avatar">
                                    <span>Xem chi ti·∫øt h·ªì s∆°</span>
                                    </a>
                                </div>
                                `;

                        });
                        container.innerHTML = html;
                    });
            });
    </script>
</div>
{% endblock %}