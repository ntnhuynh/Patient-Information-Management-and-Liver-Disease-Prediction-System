{% extends "layout/base.html" %}


{% block content %}
<div class="predict-container">
    <h1 class="predict-header">D·ª± ƒëo√°n b·ªánh gan b·∫±ng AI</h1>
    <p class="predict-meta">
        Ng∆∞·ªùi d√πng: {{ full_name }} |
        Vai tr√≤: {{ vaitro }} |
        Ng√†y: {{ current_date }}
    </p>

    <div class="predict-loading" style="display:none;">üîÑ ƒêang x·ª≠ l√Ω d·ª± ƒëo√°n...</div>
    <div class="predict-result"></div>
    <div class="predict-actions">
        <button onclick="window.history.back()" class="btn-back">‚¨ÖÔ∏è Quay v·ªÅ</button>
        <button onclick="downloadResult()" class="btn-download">üìÑ T·∫£i ƒë∆°n k·∫øt qu·∫£</button>
    </div>

</div>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        const resultBox = document.querySelector(".predict-result");
        const loadingBox = document.querySelector(".predict-loading");

        loadingBox.style.display = "block";

        fetch(`/patient/predict/{{record_id}}`)
            .then(res => res.json())
            .then(data => {
                loadingBox.style.display = "none";

                if (data.error) {
                    resultBox.innerHTML = `<div class="predict-error">‚ùå ${data.error}</div>`;
                    return;
                }

                const info = data.patient_info;
                const labs = data.lab_values;

                resultBox.innerHTML = `
                    <h2 class="predict-title">K·∫øt qu·∫£ d·ª± ƒëo√°n</h2>
                    <p><strong>D·ª± ƒëo√°n:</strong> ${data.prediction}</p>
                    <hr>
                    <h3 class="predict-subtitle">Th√¥ng tin b·ªánh nh√¢n</h3>
                    <ul class="predict-patient">
                        <li>H·ªç t√™n: ${info.full_name}</li>
                        <li>Gi·ªõi t√≠nh: ${info.gender}</li>
                        <li>Tu·ªïi: ${info.age}</li>
                        <li>Ng√†y sinh: ${info.birth_date}</li>
                    </ul>
                    <hr>
                    <h3 class="predict-subtitle">Ch·ªâ s·ªë x√©t nghi·ªám</h3>
                    <ul class="predict-labs">
                        ${Object.entries(labs).map(([key, val]) => `<li>${key}: ${val}</li>`).join("")}
                    </ul>
                `;
            })
            .catch(err => {
                loadingBox.style.display = "none";
                resultBox.innerHTML = `<div class="predict-error">‚ö†Ô∏è L·ªói khi g·ªçi API: ${err}</div>`;
            });
    });
    function downloadResult() {
        const resultBox = document.querySelector(".predict-result");
        const textContent = resultBox.innerText;

        const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "du_doan_benh_gan.txt";
        link.click();
    }

</script>
{% endblock %}