{% extends "layout/base.html" %}

{% block content %}
<div class="patients_doctor_staff-wrapper">
    <h2 id="patients_doctor_staff-title" class="patients_doctor_staff-title">Danh s√°ch b·ªánh nh√¢n...</h2>

    <div class="patients_doctor_staff-search">
        <input type="text" id="searchInput" placeholder="üîç T√¨m theo t√™n b·ªánh nh√¢n..."
            class="patients_doctor_staff-search-input">
    </div>

    <div id="patients_doctor_staff-data" class="patients_doctor_staff-card">ƒêang t·∫£i d·ªØ li·ªáu...</div>


    <div class="patients_doctor_staff-actions">
        <a href="/admin/dashboard" class="patients_doctor_staff-btn patients_doctor_staff-back">
            <i class="fas fa-arrow-left"></i> Quay v·ªÅ trang ch·ªß
        </a>
    </div>

</div>

<script>
    let allPatients = [];

    function formatDate(dateStr) {
        if (!dateStr || typeof dateStr !== "string") return "‚Äî";
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return "‚Äî";
        return date.toLocaleDateString("vi-VN");
    }

    async function loadPatients() {
        try {

            const res = await fetch(`/patient/created-by/{{ user_id }}`);
            const container = document.getElementById("patients_doctor_staff-data");

            if (!res.ok) {
                const errorData = await res.json();
                container.innerHTML = `<p class="patients_doctor_staff-error">‚ùå ${errorData.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh."}</p>`;
                return;
            }

            const data = await res.json();
            allPatients = data.patients || [];

            document.getElementById("patients_doctor_staff-title").textContent = `Danh s√°ch b·ªánh nh√¢n do b√°c sƒ© {{ full_name }} t·∫°o`;
            renderPatients(allPatients);
        } catch (err) {
            document.getElementById("patients_doctor_staff-data").innerHTML = `<p class="patients_doctor_staff-error">L·ªói khi t·∫£i d·ªØ li·ªáu.</p>`;
            console.error("L·ªói:", err);
        }
    }

    function renderPatients(patients) {
        const container = document.getElementById("patients_doctor_staff-data");
        let html = "";

        if (Array.isArray(patients) && patients.length > 0) {
            html += `<h3 class="patients_doctor_staff-subtitle">Danh s√°ch b·ªánh nh√¢n</h3>`;
            patients.forEach(p => {
                html += `
                    <div class="patients_doctor_staff-box">
                        <p><strong>H·ªç t√™n:</strong> ${p.name}</p>
                        <p><strong>Ng√†y sinh:</strong> ${p.birth_date ? formatDate(p.birth_date) : "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
                        <p><strong>Gi·ªõi t√≠nh:</strong> ${p.gender}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${p.address || "‚Äî"}</p>
                        <p><strong>SƒêT:</strong> ${p.phone || "‚Äî"}</p>

                        <div class="patients_doctor_staff-links">
                            <a href="/patients/${p.id}/detail" class="patients_doctor_staff-link">
                                <img src="{{ url_for('static', filename='img/people.png') }}" alt="avatar" class="patients_doctor_staff-avatar">
                                Xem chi ti·∫øt
                            </a>

                            <a href="/patients/${p.id}/update" class="patients_doctor_staff-link">
                                <img src="{{ url_for('static', filename='img/refresh.png') }}" alt="avatar" class="patients_doctor_staff-avatar">
                                C·∫≠p nh·∫≠t
                            </a>

                        </div>
                    </div>
                `;
            });
        } else {
            html += `<p><em class="patients_doctor_staff-empty">Kh√¥ng c√≥ b·ªánh nh√¢n n√†o ƒë∆∞·ª£c t·∫°o b·ªüi b√°c sƒ© n√†y.</em></p>`;
        }

        container.innerHTML = html;
    }

    document.getElementById("searchInput").addEventListener("input", function () {
        const keyword = this.value.toLowerCase();
        const filtered = allPatients.filter(p => p.name.toLowerCase().includes(keyword));
        renderPatients(filtered);
    });

    loadPatients();
</script>
{% endblock %}