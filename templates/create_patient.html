{% extends "layout/base.html" %}

{% block content %}

<div class="add_patient-wrapper">
    <a href="/admin/dashboard" class="add_patient-back">
        <img src="/static/img/go-back-arrow.png" alt="Quay về" />
    </a>

    <h2 class="add_patient-title">Thêm bệnh nhân</h2>

    <form id="add_patient-form" class="add_patient-form">
        <div class="form-group">
            <label>Họ tên *</label>
            <input type="text" name="name" required />
        </div>

        <div class="form-group">
            <label>Ngày sinh (DD/MM/YYYY) *</label>
            <input type="text" name="birth_date" required />
        </div>

        <div class="form-group">
            <label>Giới tính *</label>
            <select name="gender" required>
                <option value="">-- Chọn --</option>
                <option value="nam">Nam</option>
                <option value="nữ">Nữ</option>
            </select>
        </div>

        <div class="form-group">
            <label>Địa chỉ</label>
            <input type="text" name="address" />
        </div>

        <div class="form-group">
            <label>Số điện thoại</label>
            <input type="text" name="phone" />
        </div>

        <div class="form-group">
            <label>Nghề nghiệp</label>
            <input type="text" name="occupation" />
        </div>

        <div class="form-group">
            <label>Mã BHYT</label>
            <input type="text" name="insurance_code" />
        </div>

        <div class="form-group">
            <label>Số CCCD</label>
            <input type="text" name="identity_number" />
        </div>

        <div class="form-group">
            <label>Người liên hệ khẩn cấp</label>
            <input type="text" name="emergency_contact_name" />
        </div>

        <div class="form-group">
            <label>SĐT liên hệ khẩn cấp</label>
            <input type="text" name="emergency_contact_phone" />
        </div>

        <div class="form-group">
            <label>Quan hệ với bệnh nhân</label>
            <input type="text" name="emergency_contact_relation" />
        </div>

        <button type="submit" class="add_patient-btn">Thêm bệnh nhân</button>
        <p id="add_patient-msg" class="add_patient-msg"></p>
    </form>
</div>

<script>
    let departments = [];

    async function fetchDepartments() {
        try {
            const res = await fetch("/department/list");
            if (!res.ok) throw new Error("Không thể tải danh sách khoa");
            departments = await res.json();

            const datalist = document.getElementById("department-list");
            departments.forEach(dept => {
                const option = document.createElement("option");
                option.value = dept.name;
                datalist.appendChild(option);
            });
        } catch (err) {
            console.error("Lỗi khi tải khoa:", err);
        }
    }

    document.getElementById("add_patient-form").addEventListener("submit", async function (e) {
        e.preventDefault();
        const form = e.target;
        const msg = document.getElementById("add_patient-msg");

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Kiểm tra tên bệnh nhân: ít nhất 2 từ, không chứa số/ký tự đặc biệt
        const nameRegex = /^[a-zA-ZÀ-ỹ\s]+$/;
        if (data.name.trim().split(/\s+/).length < 2 || !nameRegex.test(data.name)) {
            msg.textContent = "❌ Tên bệnh nhân phải có ít nhất 2 từ, không chứa số hoặc ký tự đặc biệt.";
            msg.style.color = "red";
            return;
        }

        // Kiểm tra ngày sinh: đúng định dạng và không phải tương lai/quá xa
        const birthDateParts = data.birth_date.split("/");
        if (birthDateParts.length !== 3) {
            msg.textContent = "❌ Ngày sinh phải theo định dạng DD/MM/YYYY.";
            msg.style.color = "red";
            return;
        }

        const [day, month, year] = birthDateParts.map(Number);
        const birthDate = new Date(year, month - 1, day);
        const today = new Date();
        const age = today.getFullYear() - birthDate.getFullYear();

        if (birthDate > today) {
            msg.textContent = "❌ Ngày sinh không thể là ngày trong tương lai.";
            msg.style.color = "red";
            return;
        }
        if (age > 120 || birthDate.getFullYear() < 1900) {
            msg.textContent = "❌ Ngày sinh không hợp lệ, bệnh nhân quá lớn tuổi.";
            msg.style.color = "red";
            return;
        }

        // Gửi dữ liệu
        try {
            const res = await fetch("/patient/add-patient", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await res.json();
            if (!res.ok) {
                msg.textContent = `❌ ${result.error || "Lỗi không xác định"}`;
                msg.style.color = "red";
            } else {
                msg.textContent = `✅ ${result.msg}`;
                msg.style.color = "green";
                form.reset();
            }
        } catch (err) {
            msg.textContent = "⚠️ Lỗi hệ thống khi gửi dữ liệu.";
            msg.style.color = "red";
            console.error("Lỗi gửi:", err);
        }
    });

    fetchDepartments();
</script>
{% endblock %}