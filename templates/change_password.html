{% extends "layout/base.html" %}

{% block content %}

<div class="change_password-wrapper">
    <div class="change_password-header">
        <img src="/static/img/password.png" alt="Ảnh đại diện" class="change_password-avatar">
        <h2 class="change_password-title">Đổi mật khẩu</h2>
    </div>


    <form id="change_password-form" class="change_password-form">
        <div class="change_password-group">
            <label for="old_password">Mật khẩu hiện tại</label>
            <input type="password" id="old_password" name="old_password" required>
        </div>

        <div class="change_password-group">
            <label for="new_password">Mật khẩu mới</label>
            <input type="password" id="new_password" name="new_password" required>
        </div>

        <div class="change_password-actions">
            <a href="/admin/dashboard" class="btn change_password-cancel"><i class="fas fa-arrow-left"></i> Quay về hồ
                sơ</a>
            <button type="submit" class="btn change_password-save"><i class="fas fa-key"></i> Đổi mật khẩu</button>

        </div>
    </form>
</div>

<script>
    function isStrongPassword(password) {
        const lengthCheck = password.length >= 8;
        const upperCheck = /[A-Z]/.test(password);
        const lowerCheck = /[a-z]/.test(password);
        const numberCheck = /[0-9]/.test(password);
        const specialCheck = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        return lengthCheck && upperCheck && lowerCheck && numberCheck && specialCheck;
    }

    document.getElementById("change_password-form").addEventListener("submit", async function (e) {
        e.preventDefault();

        const oldPassword = document.getElementById("old_password").value.trim();
        const newPassword = document.getElementById("new_password").value.trim();

        if (!oldPassword || !newPassword) {
            alert("❌ Vui lòng nhập đầy đủ mật khẩu.");
            return;
        }

        if (!isStrongPassword(newPassword)) {
            alert("❌ Mật khẩu mới phải có ít nhất 8 ký tự, gồm chữ hoa, chữ thường, số và ký tự đặc biệt.");
            return;
        }

        try {
            const res = await fetch("/auth/change-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
            });

            const result = await res.json();

            if (!res.ok) {
                alert(`❌ ${result.msg}`);
                return;
            }

            alert("✅ Mật khẩu đã được thay đổi thành công!");
            window.location.href = "/profile/view";
        } catch (err) {
            alert("❌ Có lỗi xảy ra khi đổi mật khẩu.");
            console.error(err);
        }
    });
</script>


{% endblock %}