{% extends "layout/base.html" %}

{% block content %}
<div class="medical_edit-wrapper">
    <h2 class="medical_edit-title">âœï¸ Chá»‰nh sá»­a há»“ sÆ¡ bá»‡nh Ã¡n {{ record_id }}</h2>

    <form id="medical_edit-form" class="medical_edit-form">
        <!-- Ná»™i dung form sáº½ Ä‘Æ°á»£c render báº±ng JS -->
    </form>

    <div class="medical_edit-actions">
        <button type="submit" form="medical_edit-form" class="medical_edit-btn">ğŸ’¾ LÆ°u thay Ä‘á»•i</button>
        <button onclick="window.history.back()" class="btn-back">â¬… Quay vá»</button>
    </div>

    <script>
        const recordId = {{ record_id }};
        const form = document.getElementById("medical_edit-form");

        function safe(val) {
            return val !== null && val !== undefined ? val : "";
        }

        function input(label, name, value = "", type = "text") {
            return `
        <div class="medical_edit-field">
          <label><strong>${label}:</strong></label>
          <input type="${type}" name="${name}" value="${value}" class="medical_edit-input">
        </div>
      `;
        }

        function textarea(label, name, value = "") {
            return `
        <div class="medical_edit-field">
          <label><strong>${label}:</strong></label>
          <textarea name="${name}" class="medical_edit-textarea">${value}</textarea>
        </div>
      `;
        }

        fetch(`/medical-record/get_medical-records/${recordId}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    form.innerHTML = `<p style="color:red;">${data.error}</p>`;
                    return;
                }

                let html = `
          <h3>ThÃ´ng tin chung</h3>
          ${input("NgÃ y khÃ¡m", "visit_date", safe(data.visit_date), "date")}
          ${input("LÃ½ do khÃ¡m", "reason_for_visit", safe(data.reason_for_visit))}
          ${input("Triá»‡u chá»©ng chÃ­nh", "main_symptoms", safe(data.main_symptoms))}
          ${input("Thá»i Ä‘iá»ƒm khá»Ÿi phÃ¡t", "onset_time", safe(data.onset_time))}
          ${input("Ghi chÃº", "progress_note", safe(data.progress_note))}

          <div class="medical_edit-flexbox">
            <div class="medical_edit-column">
              <h3>KhÃ¡m lÃ¢m sÃ ng</h3>
              ${input("Huyáº¿t Ã¡p", "blood_pressure", safe(data.blood_pressure))}
              ${input("Nhá»‹p tim", "heart_rate", safe(data.heart_rate))}
              ${input("Nhiá»‡t Ä‘á»™", "temperature", safe(data.temperature))}
              ${input("Nhá»‹p thá»Ÿ", "respiratory_rate", safe(data.respiratory_rate))}
              ${input("CÃ¢n náº·ng", "weight", safe(data.weight))}
              ${input("Chiá»u cao", "height", safe(data.height))}
              ${input("Tim máº¡ch", "exam_cardio", safe(data.exam_cardio))}
              ${input("HÃ´ háº¥p", "exam_respiratory", safe(data.exam_respiratory))}
              ${input("TiÃªu hÃ³a", "exam_digestive", safe(data.exam_digestive))}
              ${input("Tháº§n kinh", "exam_neuro", safe(data.exam_neuro))}
              ${input("Da liá»…u", "exam_skin", safe(data.exam_skin))}
            </div>

            <div class="medical_edit-column">
              <h3>Cáº­n lÃ¢m sÃ ng</h3>
              ${textarea("Chá»‰ Ä‘á»‹nh", "orders", safe(data.orders))}
              ${textarea("TÃ³m táº¯t káº¿t quáº£", "result_summary", safe(data.result_summary))}
              ${input("Tá»•ng Bilirubin", "total_bilirubin", safe(data.total_bilirubin))}
              ${input("Bilirubin trá»±c tiáº¿p", "direct_bilirubin", safe(data.direct_bilirubin))}
              ${input("Alkaline Phosphotase", "alkaline_phosphotase", safe(data.alkaline_phosphotase))}
              ${input("ALT", "alamine_aminotransferase", safe(data.alamine_aminotransferase))}
              ${input("AST", "aspartate_aminotransferase", safe(data.aspartate_aminotransferase))}
              ${input("Tá»•ng Protein", "total_proteins", safe(data.total_proteins))}
              ${input("Albumin", "albumin", safe(data.albumin))}
              ${input("Tá»· lá»‡ Albumin/Globulin", "albumin_globulin_ratio", safe(data.albumin_globulin_ratio))}
            </div>
          </div>

          <h3>Cháº©n Ä‘oÃ¡n & Äiá»u trá»‹</h3>
          ${input("Cháº©n Ä‘oÃ¡n sÆ¡ bá»™", "preliminary_diagnosis", safe(data.preliminary_diagnosis))}
          ${input("Cháº©n Ä‘oÃ¡n xÃ¡c Ä‘á»‹nh", "confirmed_diagnosis", safe(data.confirmed_diagnosis))}
          ${textarea("Thuá»‘c", "medications", safe(data.medications))}
          ${textarea("Thá»§ thuáº­t", "procedures", safe(data.procedures))}
          ${textarea("HÆ°á»›ng dáº«n theo dÃµi", "follow_up_instructions", safe(data.follow_up_instructions))}
          ${input("NgÃ y tÃ¡i khÃ¡m", "follow_up_date", safe(data.follow_up_date), "date")}

          <h3>Xuáº¥t viá»‡n</h3>
          ${input("NgÃ y nháº­p viá»‡n", "admission_date", safe(data.admission_date), "date")}
          ${input("NgÃ y xuáº¥t viá»‡n", "discharge_date", safe(data.discharge_date), "date")}
          ${input("Cháº©n Ä‘oÃ¡n khi xuáº¥t viá»‡n", "discharge_diagnosis", safe(data.discharge_diagnosis))}
          ${input("Káº¿t quáº£ Ä‘iá»u trá»‹", "treatment_outcome", safe(data.treatment_outcome))}
          ${textarea("HÆ°á»›ng dáº«n sau xuáº¥t viá»‡n", "post_discharge_instructions", safe(data.post_discharge_instructions))}
        `;

                form.innerHTML = html;
            });

        form.onsubmit = function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const jsonData = {};
            formData.forEach((val, key) => {
                if (val !== null && val !== undefined && val !== "") {
                    jsonData[key] = val;
                }
            });

            fetch(`/medical-record/update_medical-records/${recordId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(jsonData)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        alert("âœ… Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t!");
                        window.location.href = `/medical-records_detail/${recordId}`;
                    } else {
                        alert("âŒ " + (data.error || "Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh"));
                    }
                });
        };
    </script>
</div>
{% endblock %}