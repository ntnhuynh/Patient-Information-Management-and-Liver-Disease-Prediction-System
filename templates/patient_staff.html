{% extends "layout/base.html" %}

{% block content %}
<div class="stats_doctor-wrapper">
    <h2 id="stats_doctor-title" class="stats_doctor-title">Danh s√°ch b·ªánh nh√¢n...</h2>

    <div class="stats_doctor-search">
        <input type="text" id="searchInput" placeholder="üîç T√¨m theo t√™n b·ªánh nh√¢n..."
            class="stats_doctor-search-input">
    </div>

    <div id="stats_patient-data" class="stats_doctor-card">ƒêang t·∫£i d·ªØ li·ªáu...</div>

    {% if page_type == "admin" %}
    <div class="stats_doctor-actions">
        <a href="/create/department" class="stats_doctor-btn stats_doctor-back">
            <i class="fas fa-arrow-left"></i> Quay v·ªÅ danh s√°ch khoa
        </a>
    </div>
    {% elif page_type == "department_head" %}
    <div class="stats_doctor-actions">
        <a href="/admin/dashboard" class="stats_doctor-btn stats_doctor-back">
            <i class="fas fa-arrow-left"></i> Quay v·ªÅ danh s√°ch khoa
        </a>
    </div>
    {% endif %}
</div>

<script>
    let allPatients = [];
    let originalDepartmentName = "";
    function formatDate(dateStr) {
        if (!dateStr || typeof dateStr !== "string") return "‚Äî";

        const cleanStr = dateStr.trim();
        const parts = cleanStr.split("-"); // T√°ch theo d·∫•u g·∫°ch ngang

        if (parts.length !== 3) return "‚Äî";

        const [day, month, year] = parts.map(p => parseInt(p, 10));
        if (!day || !month || !year) return "‚Äî";

        const date = new Date(year, month - 1, day); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
        if (isNaN(date.getTime())) return "‚Äî";

        const formattedDay = String(date.getDate()).padStart(2, '0');
        const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
        const formattedYear = date.getFullYear();

        return `${formattedDay}/${formattedMonth}/${formattedYear}`;
    }

    async function loadPatients() {
        try {
            const pathParts = window.location.pathname.split('/');
            const khoaId = pathParts[pathParts.indexOf('patients') + 1];

            const res = await fetch(`/patient/list/${khoaId}/patients`);
            const container = document.getElementById("stats_patient-data");

            if (!res.ok) {
                const errorData = await res.json();
                container.innerHTML = `<p class="stats_doctor-error">‚ùå ${errorData.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh."}</p>`;
                return;
            }

            const data = await res.json();
            allPatients = data.patients || [];
            originalDepartmentName = data.department_name;
            console.log(data)
            document.getElementById("stats_doctor-title").textContent = `Danh s√°ch b·ªánh nh√¢n ${originalDepartmentName}`;
            renderPatients(allPatients, data.pagination);
        } catch (err) {
            document.getElementById("stats_patient-data").innerHTML = `<p class="stats_doctor-error">L·ªói khi t·∫£i d·ªØ li·ªáu.</p>`;
            console.error("L·ªói:", err);
        }
    }

    function renderPatients(patients, pagination) {
        const container = document.getElementById("stats_patient-data");
        let html = "";

        if (Array.isArray(patients) && patients.length > 0) {
            html += `<h3 class="stats_doctor-subtitle">Danh s√°ch b·ªánh nh√¢n</h3>`;
            patients.forEach(p => {
                html += `
                        <div class="stats_doctor-box">
                            <p><strong>H·ªç t√™n:</strong> ${p.name}</p>
                            <p><strong>Ng√†y sinh:</strong> ${p.birth_date ? formatDate(p.birth_date) : "Ch∆∞a c·∫≠p nh·∫≠t"}</p>
                            <p><strong>Gi·ªõi t√≠nh:</strong> ${p.gender}</p>
                            <p><strong>ƒê·ªãa ch·ªâ:</strong> ${p.address}</p>
                            <p><strong>B√°c sƒ© ph·ª• tr√°ch:</strong> ${p.doctor_name}</p>

                            <div class="stats_doctor-links">
                                <a href="/patients/${p.id}/detail" class="stats_doctor-link">
                                    <img src="{{ url_for('static', filename='img/people.png') }}" alt="avatar" class="stats_doctor-avatar">

                                    Xem chi ti·∫øt
                                </a>
                                {% if page_type == "department head" %}
                                <a href="/patients/${p.id}/update" class="stats_doctor-link">
                                    <img src="{{ url_for('static', filename='img/refresh.png') }}" alt="avatar" class="stats_doctor-avatar">

                                    C·∫≠p nh·∫≠t
                                </a>
                                {%endif%}
                            </div>

                        </div>
                `;
            });
        } else {
            html += `<p><em class="stats_doctor-empty">Kh√¥ng c√≥ b·ªánh nh√¢n n√†o trong khoa n√†y.</em></p>`;
        }

        if (pagination) {
            html += `
                <div class="stats_doctor-pagination">
                    <p><strong>Trang:</strong> ${pagination.page} / ${pagination.total_pages}</p>
                    <p><strong>T·ªïng s·ªë b·ªánh nh√¢n:</strong> ${pagination.total_items}</p>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    document.getElementById("searchInput").addEventListener("input", function () {
        const keyword = this.value.toLowerCase();
        const filtered = allPatients.filter(p => p.name.toLowerCase().includes(keyword));
        renderPatients(filtered, null);
    });

    loadPatients();
</script>
{% endblock %}