{% extends "layout/base.html" %}

{% block content %}
<div class="medical_records_detail-wrapper">
    <h2 class="medical_records_detail-title">üìù H·ªì s∆° b·ªánh √°n {{ record_id }}</h2>

    <div id="medical_records_detail-info" class="medical_records_detail-card">
        <!-- N·ªôi dung h·ªì s∆° s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
    </div>

    {% if page_type == "department_head_list" %}
    <div class="medical_records_detail-actions">
        <button onclick="window.history.back()" class="btn-back">‚¨Ö Quay v·ªÅ</button>
    </div>
    <div class="medical_records_detail-actions">
        <button onclick="downloadMedicalRecord()" class="medical_records_detail-btn medical_records_detail-download">
            <i class="fas fa-download"></i> T·∫£i h·ªì s∆° v·ªÅ (.txt)
        </button>
    </div>
    {%elif page_type == "doctor"%}
    <div class="medical_records_detail-actions">
        <button onclick="window.history.back()" class="btn-back">‚¨Ö Quay v·ªÅ</button>
    </div>
    <div class="medical_records_detail-actions">
        <button onclick="downloadMedicalRecord()" class="medical_records_detail-btn medical_records_detail-download">
            <i class="fas fa-download"></i> T·∫£i h·ªì s∆° v·ªÅ (.txt)
        </button>
    </div>
    {% else %}
    <div class="medical_records_detail-actions">
        <button onclick="window.history.back()" class="btn-back">‚¨Ö Quay v·ªÅ</button>
    </div>
    <div class="medical_records_detail-actions">
        <button onclick="downloadMedicalRecord()" class="medical_records_detail-btn medical_records_detail-download">
            <i class="fas fa-download"></i> T·∫£i h·ªì s∆° v·ªÅ (.txt)
        </button>
    </div>
    {%endif%}


    <script>
        function safeValue(val) {
            return val !== null && val !== undefined && val !== "" ? val : "";
        }

        const recordId = {{ record_id }};
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            if (isNaN(date)) return "‚Äî";
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        fetch(`/medical-record/get_medical-records/${recordId}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("medical_records_detail-info").innerHTML = `<p style="color:red;">${data.error}</p>`;
                    return;
                }

                const infoDiv = document.getElementById("medical_records_detail-info");
                let html = `
                    <h3> Th√¥ng tin chung</h3>
                    <p><strong>Ng√†y kh√°m:</strong> ${formatDate(data.visit_date)}</p>
                    <p><strong>L√Ω do kh√°m:</strong> ${safeValue(data.reason_for_visit)}</p>
                    <p><strong>Tri·ªáu ch·ª©ng ch√≠nh:</strong> ${safeValue(data.main_symptoms)}</p>
                    <p><strong>Th·ªùi gian kh·ªüi ph√°t:</strong> ${safeValue(data.onset_time)}</p>
                    <p><strong>Ghi ch√∫:</strong> ${safeValue(data.progress_note)}</p>

                    <div class="medical_records_detail-flexbox">
                        <div class="medical_records_detail-column">
                            <h3>Kh√°m l√¢m s√†ng</h3>
                            <p><strong>Huy·∫øt √°p:</strong> ${safeValue(data.blood_pressure)}</p>
                            <p><strong>Nh·ªãp tim:</strong> ${safeValue(data.heart_rate)}</p>
                            <p><strong>Nhi·ªát ƒë·ªô:</strong> ${safeValue(data.temperature)}</p>
                            <p><strong>Nh·ªãp th·ªü:</strong> ${safeValue(data.respiratory_rate)}</p>
                            <p><strong>C√¢n n·∫∑ng:</strong> ${safeValue(data.weight)}</p>
                            <p><strong>Chi·ªÅu cao:</strong> ${safeValue(data.height)}</p>
                            <p><strong>Tim m·∫°ch:</strong> ${safeValue(data.exam_cardio)}</p>
                            <p><strong>H√¥ h·∫•p:</strong> ${safeValue(data.exam_respiratory)}</p>
                            <p><strong>Ti√™u h√≥a:</strong> ${safeValue(data.exam_digestive)}</p>
                            <p><strong>Th·∫ßn kinh:</strong> ${safeValue(data.exam_neuro)}</p>
                            <p><strong>Da li·ªÖu:</strong> ${safeValue(data.exam_skin)}</p>
                        </div>

                        <div class="medical_records_detail-column">
                            <h3>C·∫≠n l√¢m s√†ng</h3>
                            <p><strong>T·ªïng Bilirubin:</strong> ${safeValue(data.total_bilirubin)}</p>
                            <p><strong>Bilirubin tr·ª±c ti·∫øp:</strong> ${safeValue(data.direct_bilirubin)}</p>
                            <p><strong>Alkaline Phosphotase:</strong> ${safeValue(data.alkaline_phosphotase)}</p>
                            <p><strong>ALT:</strong> ${safeValue(data.alamine_aminotransferase)}</p>
                            <p><strong>AST:</strong> ${safeValue(data.aspartate_aminotransferase)}</p>
                            <p><strong>T·ªïng Protein:</strong> ${safeValue(data.total_proteins)}</p>
                            <p><strong>Albumin:</strong> ${safeValue(data.albumin)}</p>
                            <p><strong>T·ª∑ l·ªá Albumin/Globulin:</strong> ${safeValue(data.albumin_globulin_ratio)}</p>
                            <p><strong>T√≥m t·∫Øt k·∫øt qu·∫£:</strong> ${safeValue(data.result_summary)}</p>
                            <p><strong>Ch·ªâ ƒë·ªãnh:</strong> ${safeValue(data.orders)}</p>
                        </div>
                    </div>
                            

                    <h3>Ch·∫©n ƒëo√°n & ƒêi·ªÅu tr·ªã</h3>
                    <p><strong>Ch·∫©n ƒëo√°n s∆° b·ªô:</strong> ${safeValue(data.preliminary_diagnosis)}</p>
                    <p><strong>Ch·∫©n ƒëo√°n x√°c ƒë·ªãnh:</strong> ${safeValue(data.confirmed_diagnosis)}</p>
                    <p><strong>Thu·ªëc:</strong> ${data.medications ? JSON.stringify(data.medications) : ""}</p>
                    <p><strong>Th·ªß thu·∫≠t:</strong> ${safeValue(data.procedures)}</p>
                    <p><strong>H∆∞·ªõng d·∫´n theo d√µi:</strong> ${safeValue(data.follow_up_instructions)}</p>
                    <p><strong>Ng√†y t√°i kh√°m:</strong> ${formatDate(safeValue(data.follow_up_date))}</p>

                    <h3>Xu·∫•t vi·ªán</h3>
                    <p><strong>Ng√†y nh·∫≠p vi·ªán:</strong> ${formatDate(safeValue(data.admission_date))}</p>
                    <p><strong>Ng√†y xu·∫•t vi·ªán:</strong> ${formatDate(safeValue(data.discharge_date))}</p>
                    <p><strong>Ch·∫©n ƒëo√°n khi xu·∫•t vi·ªán:</strong> ${safeValue(data.discharge_diagnosis)}</p>
                    <p><strong>K·∫øt qu·∫£ ƒëi·ªÅu tr·ªã:</strong> ${safeValue(data.treatment_outcome)}</p>
                    <p><strong>H∆∞·ªõng d·∫´n sau xu·∫•t vi·ªán:</strong> ${safeValue(data.post_discharge_instructions)}</p>
                `;
                infoDiv.innerHTML = html;
            })
            .catch(err => {
                document.getElementById("medical_records_detail-info").innerHTML = "<p>L·ªói khi t·∫£i d·ªØ li·ªáu h·ªì s∆°.</p>";
                console.error(err);
            });
        function downloadMedicalRecord() {
            const infoDiv = document.getElementById("medical_records_detail-info");
            const textContent = infoDiv.innerText;

            const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `ho_so_benh_an_${recordId}.txt`;
            link.click();
        }

    </script>
    {% endblock %}